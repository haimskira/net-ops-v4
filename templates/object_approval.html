<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>NetOps - Object Approval & History</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        @font-face {
            font-family: 'Assistant';
            src: url("{{ url_for('static', filename='fonts/Assistant-Regular.ttf') }}") format('truetype');
            font-weight: 400;
        }
        @font-face {
            font-family: 'Assistant';
            src: url("{{ url_for('static', filename='fonts/Assistant-Bold.ttf') }}") format('truetype');
            font-weight: 700;
        }
        body { font-family: 'Assistant', sans-serif !important; background-color: #0f172a; color: #f8fafc; padding: 20px; }
        
        .obj-card { transition: all 0.3s ease; border-width: 1px; }
        .obj-approved { border-color: #10b981 !important; background: rgba(16, 185, 129, 0.05) !important; opacity: 0.85; }
        .obj-rejected { border-color: #ef4444 !important; background: rgba(239, 68, 68, 0.05) !important; opacity: 0.85; }
        .obj-pending { border-color: #334155; background: rgba(30, 41, 59, 0.4); }

        .modal { backdrop-filter: blur(8px); background-color: rgba(15, 23, 42, 0.8); }
        select, input, textarea { background-color: #1e293b !important; color: white !important; border: 1px solid #334155 !important; }
        
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9) translateY(20px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }

        .member-badge { background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.2); padding: 1px 6px; border-radius: 4px; font-size: 10px; margin: 1px; display: inline-block; color: #a5b4fc; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .custom-checkbox {
            appearance: none; background-color: #1e293b; margin: 0; font: inherit; color: currentColor; width: 1.25em; height: 1.25em; border: 2px solid #a855f7; border-radius: 0.25em; display: grid; place-content: center; cursor: pointer;
        }
        .custom-checkbox::before {
            content: ""; width: 0.65em; height: 0.65em; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em white; transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked::before { transform: scale(1); }
        .custom-checkbox:checked { background-color: #a855f7; }
    </style>
</head>
<body>
    
    <div class="flex justify-between items-center mb-6 bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-xl sticky top-0 z-40">
        <div>
            <h1 class="text-2xl font-bold text-purple-400">× ×™×”×•×œ ×•××™×©×•×¨ ××•×‘×™×™×§×˜×™×</h1>
            <p class="text-slate-500 text-sm">××™×©×•×¨ ×‘×§×©×•×ª ×—×“×©×•×ª ×•×¦×¤×™×™×” ×‘×”×™×¡×˜×•×¨×™×™×ª ×ª×©×ª×™×ª</p>
        </div>
        
        <div class="flex gap-4 items-center">
            <div id="bulk-toolbar" class="hidden flex items-center gap-3 bg-slate-800 px-4 py-2 rounded-xl border border-slate-700">
                <span id="selected-count" class="text-white font-bold text-sm ml-2">0 × ×‘×—×¨×•</span>
                <button onclick="bulkReject()" class="text-rose-400 border border-rose-600/30 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-rose-600 hover:text-white transition-colors">×“×—×” ××¡×•×× ×™×</button>
                <button onclick="bulkApprove()" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-colors shadow-lg">××©×¨ ××¡×•×× ×™×</button>
            </div>

            <div class="h-8 w-px bg-slate-700 mx-2"></div>

            <button onclick="loadObjects()" class="bg-slate-800 hover:bg-slate-700 p-3 rounded-xl transition-all border border-slate-700 text-slate-400 hover:text-white">
                <span class="text-xl">ğŸ”„</span>
            </button>
        </div>
    </div>

    <div id="objects-container" class="space-y-4 pb-20"></div>

    <div id="confirmModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal">
        <div class="bg-slate-900 border border-purple-500/30 p-8 rounded-3xl w-full max-w-sm shadow-2xl text-center pop-in relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-purple-500 to-fuchsia-600"></div>
            <h3 class="text-2xl font-bold text-white mb-2">××™×©×•×¨ ××•×‘×™×™×§×˜×™×</h3>
            <p id="confirmMessage" class="text-slate-400 text-sm mb-8 px-4">×”×× ××ª×” ×‘×˜×•×—? ×”×¤×¢×•×œ×” ×ª×™×¦×•×¨ ××ª ×”××•×‘×™×™×§×˜×™× ×‘×¤×™×™×¨×•×•×œ.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeConfirmModal()" class="px-6 py-2.5 rounded-xl text-slate-400 hover:bg-slate-800 transition-all font-bold text-sm">×‘×™×˜×•×œ</button>
                <button onclick="executeBulkApprove()" class="px-6 py-2.5 rounded-xl bg-purple-600 text-white font-bold shadow-lg text-sm transition-all">×›×Ÿ, ×‘×¦×¢ ××™×©×•×¨</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden pop-in">
            <div class="p-6 border-b border-slate-800 bg-purple-600/10 flex justify-between items-center">
                <h2 class="text-xl font-bold text-purple-400">×¢×¨×™×›×ª ×¤×¨×˜×™ ×‘×§×©×”</h2>
            </div>
            <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-6" id="editForm">
                <input type="hidden" id="edit_id">
                <div class="md:col-span-2 space-y-1">
                    <label class="text-xs text-slate-500 font-bold">×©× ×”××•×‘×™×™×§×˜</label>
                    <input id="edit_name" class="w-full p-2.5 rounded-xl outline-none">
                </div>
                <div class="md:col-span-2 space-y-1">
                    <label class="text-xs text-slate-500 font-bold">×¢×¨×š (IP ××• ×—×‘×¨×™ ×§×‘×•×¦×” ××•×¤×¨×“×™× ×‘×¤×¡×™×§)</label>
                    <input id="edit_value" class="w-full p-2.5 rounded-xl outline-none">
                </div>
                <div class="space-y-1 hidden" id="field_prefix">
                    <label class="text-xs text-blue-400 font-bold">Prefix (Mask)</label>
                    <select id="edit_prefix" class="w-full p-2.5 rounded-xl outline-none">
                        <option value="32">/32</option>
                        <option value="24">/24</option>
                        <option value="16">/16</option>
                    </select>
                </div>
                <div class="space-y-1 hidden" id="field_protocol">
                    <label class="text-xs text-orange-400 font-bold">Protocol</label>
                    <select id="edit_protocol" class="w-full p-2.5 rounded-xl outline-none">
                        <option value="tcp">TCP</option>
                        <option value="udp">UDP</option>
                    </select>
                </div>
            </div>
            <div class="p-6 bg-slate-900/50 flex justify-end gap-3 border-t border-slate-800">
                <button onclick="closeEdit()" class="px-6 py-2 rounded-xl text-slate-400 hover:bg-slate-800 transition-all font-bold text-sm">×‘×™×˜×•×œ</button>
                <button onclick="saveEdit()" class="px-8 py-2 rounded-xl bg-purple-600 text-white hover:bg-purple-500 font-bold shadow-lg text-sm">×©××•×¨ ×¢×“×›×•×Ÿ</button>
            </div>
        </div>
    </div>

    <div id="rejectModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-full max-w-md shadow-2xl pop-in">
            <h3 class="text-xl font-bold text-rose-400 mb-4">×“×—×™×™×ª ×‘×§×©×”</h3>
            <textarea id="rejectReason" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white mb-6 h-32 outline-none focus:border-rose-500" placeholder="×”×¡×‘×¨ ×œ××©×ª××© ××“×•×¢ ×”×‘×§×©×” × ×“×—×ª×”..."></textarea>
            <div class="flex justify-end gap-3 font-bold">
                <button onclick="closeRejectModal()" class="text-slate-400 hover:text-white px-4 py-2">×‘×™×˜×•×œ</button>
                <button id="confirmRejectBtn" class="bg-rose-600 hover:bg-rose-500 text-white px-6 py-2 rounded-xl">×‘×¦×¢ ×“×—×™×™×”</button>
            </div>
        </div>
    </div>

    <script>
        let allObjects = [];
        let selectedObjects = new Set();
        let objectIdToReject = null;

        window.onload = loadObjects;

        /**
         * ×˜×¢×™× ×ª ×›×œ ×”××•×‘×™×™×§×˜×™× (×›×•×œ×œ ×”×™×¡×˜×•×¨×™×”) ×•×¢×“×›×•×Ÿ ××•× ×™×
         */
        async function loadObjects() {
            try {
                const res = await fetch('/get-admin-view-objects');
                allObjects = await res.json();
                
                // ×¢×“×›×•×Ÿ ×”××•× ×” ×‘-Navbar ×©×œ ×”-Parent (×¨×§ ×‘×§×©×•×ª Pending)
                const pendingCount = allObjects.filter(o => (o.status||'').toLowerCase() === 'pending').length;
                window.parent.postMessage({ type: 'UPDATE_COUNTER', source: 'objects', count: pendingCount }, '*');

                renderUI();
            } catch (e) {
                document.getElementById('objects-container').innerHTML = '<p class="text-rose-500 text-center py-10">×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª</p>';
            }
        }

        // --- ×œ×•×’×™×§×” ×©×œ ×‘×—×™×¨×” ××¨×•×‘×” ---
        function toggleSelection(id) {
            if (selectedObjects.has(id)) selectedObjects.delete(id);
            else selectedObjects.add(id);
            updateBulkToolbar();
        }

        function updateBulkToolbar() {
            const toolbar = document.getElementById('bulk-toolbar');
            const countSpan = document.getElementById('selected-count');
            if (selectedObjects.size > 0) {
                toolbar.classList.remove('hidden');
                toolbar.classList.add('flex');
                countSpan.innerText = `${selectedObjects.size} × ×‘×—×¨×•`;
            } else {
                toolbar.classList.add('hidden');
                toolbar.classList.remove('flex');
            }
        }

        // --- ××™×©×•×¨ (Approve) ---
        function bulkApprove() {
            if (selectedObjects.size === 0) return;
            document.getElementById('confirmMessage').innerHTML = `×”×× ×œ××©×¨ <b>${selectedObjects.size}</b> ××•×‘×™×™×§×˜×™× ×œ×™×¦×™×¨×” ×‘×¤×™×™×¨×•×•×œ?`;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        async function executeBulkApprove() {
            closeConfirmModal();
            const ids = Array.from(selectedObjects);
            for (let id of ids) {
                // ×§×¨×™××” ×œ× ×ª×™×‘ ×”××™×©×•×¨ ×‘-Backend
                await fetch(`/approve-object/${id}`, { method: 'POST' });
            }
            selectedObjects.clear();
            updateBulkToolbar();
            loadObjects();
        }

        function closeConfirmModal() { document.getElementById('confirmModal').classList.add('hidden'); }

        // --- ×“×—×™×™×” (Reject) ---
        function bulkReject() {
            objectIdToReject = null;
            document.getElementById('rejectReason').value = "";
            document.getElementById('rejectModal').classList.remove('hidden');
        }

        function openRejectModal(id) {
            objectIdToReject = id;
            document.getElementById('rejectReason').value = "";
            document.getElementById('rejectModal').classList.remove('hidden');
        }

        document.getElementById('confirmRejectBtn').onclick = async function() {
            const reason = document.getElementById('rejectReason').value.trim();
            if (!reason) return alert("×—×•×‘×” ×œ×”×–×™×Ÿ ×¡×™×‘×”.");

            const ids = objectIdToReject ? [objectIdToReject] : Array.from(selectedObjects);
            for (let id of ids) {
                await fetch(`/reject-object/${id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ reason: reason })
                });
            }
            selectedObjects.clear();
            updateBulkToolbar();
            closeRejectModal();
            loadObjects();
        };

        function closeRejectModal() { document.getElementById('rejectModal').classList.add('hidden'); }

        // --- ×¢×¨×™×›×” (Edit) ---
        function openEdit(id) {
            const obj = allObjects.find(o => o.id === id);
            if (!obj) return;
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('edit_id').value = obj.id;
            document.getElementById('edit_name').value = obj.name;
            document.getElementById('edit_value').value = obj.value;

            const type = (obj.obj_type || obj.type || '').toLowerCase();
            document.getElementById('field_prefix').classList.toggle('hidden', !type.includes('address') || type.includes('group'));
            document.getElementById('field_protocol').classList.toggle('hidden', !type.includes('service') || type.includes('group'));
            
            if (obj.prefix) document.getElementById('edit_prefix').value = obj.prefix;
            if (obj.protocol) document.getElementById('edit_protocol').value = obj.protocol;
        }

        function closeEdit() { document.getElementById('editModal').classList.add('hidden'); }

        async function saveEdit() {
            const id = document.getElementById('edit_id').value;
            const data = {
                name: document.getElementById('edit_name').value,
                value: document.getElementById('edit_value').value,
                prefix: document.getElementById('edit_prefix').value,
                protocol: document.getElementById('edit_protocol').value
            };
            try {
                await fetch(`/update-pending-object/${id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                closeEdit();
                loadObjects();
            } catch(e) { alert("×©×’×™××” ×‘×¢×“×›×•×Ÿ"); }
        }

        // --- ×‘× ×™×™×ª ×”×××©×§ (Render UI) ---
        function renderUI() {
            const container = document.getElementById('objects-container');
            if (!allObjects || allObjects.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-center py-20 italic">××™×Ÿ ×‘×§×©×•×ª ×œ×”×¦×’×”.</p>';
                return;
            }

            container.innerHTML = allObjects.map(obj => {
                const status = (obj.status || 'Pending').toLowerCase();
                let statusClass = status === 'approved' ? "obj-approved" : status === 'rejected' ? "obj-rejected" : "obj-pending";
                
                let badgeColor = status === 'approved' ? 'text-emerald-500 bg-emerald-500/10' : status === 'rejected' ? 'text-rose-500 bg-rose-500/10' : 'text-orange-400 bg-orange-400/10';
                let statusLabel = status === 'approved' ? 'âœ” ××•×©×¨' : status === 'rejected' ? 'âœ˜ × ×“×—×”' : 'â³ ×××ª×™×Ÿ';

                const type = (obj.obj_type || obj.type || 'ADDRESS').toUpperCase();
                const isChecked = selectedObjects.has(obj.id) ? 'checked' : '';

                // ×˜×™×¤×•×œ ×‘×¢×¨×š: ×× ×–×• ×§×‘×•×¦×”, × ×¦×™×’ ×—×‘×¨×™× ×›×¤×™×œ×™×
                let displayVal = "";
                if (type.includes('GROUP')) {
                    const members = obj.value ? obj.value.split(',') : [];
                    displayVal = members.map(m => `<span class="member-badge">${m.trim()}</span>`).join('');
                } else {
                    displayVal = `<span class="font-mono text-slate-300 text-xs">${obj.value}${obj.prefix ? '/'+obj.prefix : ''} ${obj.protocol ? '['+obj.protocol+']' : ''}</span>`;
                }

                return `
                <div class="obj-card border p-5 rounded-2xl flex justify-between items-center ${statusClass}">
                    <div class="ml-4 flex items-center justify-center">
                        ${status === 'pending' ? `<input type="checkbox" class="custom-checkbox" onchange="toggleSelection(${obj.id})" ${isChecked}>` : '<div class="w-5 text-slate-700">#</div>'}
                    </div>
                    
                    <div class="grid grid-cols-5 gap-6 flex-1 text-right text-sm items-center">
                        <div><p class="text-slate-500 text-[10px] mb-1 italic">××‘×§×©</p><p class="font-bold text-slate-200 truncate">ğŸ‘¤ ${obj.requested_by}</p></div>
                        <div><p class="text-slate-500 text-[10px] mb-1">×¡×•×’</p><p class="text-indigo-400 font-black text-[11px] tracking-widest">${type}</p></div>
                        <div><p class="text-slate-500 text-[10px] mb-1">×©×</p><p class="font-mono text-purple-300 font-bold truncate text-xs" title="${obj.name}">${obj.name}</p></div>
                        <div class="col-span-1">
                            <p class="text-slate-500 text-[10px] mb-1">×¢×¨×š / ×—×‘×¨×™×</p>
                            <div class="max-h-12 overflow-y-auto custom-scroll">${displayVal}</div>
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="px-3 py-1 rounded-full border border-current text-[10px] font-bold ${badgeColor}">${statusLabel}</span>
                        </div>
                    </div>

                    <div class="flex gap-2 mr-6 min-w-[150px] justify-end">
                        ${status === 'pending' ? `
                            <button onclick="openEdit(${obj.id})" class="bg-slate-700 p-2 rounded-xl hover:bg-purple-600 transition-all">ğŸ“</button>
                            <button onclick="openRejectModal(${obj.id})" class="text-rose-400 border border-rose-600/30 px-3 py-1.5 rounded-xl text-xs font-bold hover:bg-rose-600 hover:text-white">×“×—×™×™×”</button>
                            <button onclick="selectedObjects.add(${obj.id}); bulkApprove();" class="bg-purple-600 hover:bg-purple-500 text-white px-5 py-1.5 rounded-xl text-xs font-bold shadow-lg">××©×¨</button>
                        ` : `
                            <div class="text-left">
                                <p class="text-slate-500 text-[9px] uppercase font-bold">×ª××¨×™×š ×¤×¢×•×œ×”:</p>
                                <p class="text-[10px] text-slate-400 font-mono">${obj.request_time || 'N/A'}</p>
                            </div>
                        `}
                    </div>
                </div>
                ${obj.admin_notes ? `
                    <div class="mr-14 mb-4 mt-1 p-3 bg-indigo-500/5 border-r-2 border-indigo-500/20 rounded-l-xl">
                        <p class="text-xs text-slate-400 italic">ğŸ’¬ ×”×¢×¨×ª ××“××™×Ÿ: ${obj.admin_notes}</p>
                    </div>` : ''}
                `;
            }).join('');
        }

        // ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×›×œ 30 ×©× ×™×•×ª
        setInterval(loadObjects, 30000);
    </script>
</body>
</html>